<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√©ka≈ôsk√Ω posudek - Gener√°tor</title>
    
    <!-- Extern√≠ knihovny -->
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* Nastaven√≠ barev - P≈ôid√°na promƒõnn√° --input-border pro tmav≈°√≠ r√°meƒçky */
        :root { 
            --bg:#f7fbff; 
            --card:#ffffff; 
            --muted:#5a718a; 
            --text:#102a43; 
            --accent:#005DA8; 
            --border:#e5eef6;        /* Jemn√Ω r√°meƒçek pro kartu */
            --input-border:#b8c6d6;  /* Tmav≈°√≠ r√°meƒçek pro inputy */
            --error:#D32F2F; 
            --success:#388E3C; 
        }
        
        * { box-sizing: border-box; }
        html, body { height:100%; }
        body { margin:0; font-family:system-ui,-apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial,"Apple Color Emoji","Segoe UI Emoji"; color:var(--text); background:var(--bg); -webkit-print-color-adjust:exact; print-color-adjust:exact; }
        
        .container{ max-width:1100px; margin:0 auto; padding:32px 16px 80px; }
        
        header{ display:flex; align-items:center; justify-content:flex-start; gap:16px; margin-bottom:20px; border-top:6px solid var(--accent); padding-top:16px; }
        h1{ font-size:28px; margin:0; letter-spacing:.4px; color:var(--accent); }
        
        .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 8px 30px rgba(16,42,67,.08); }
        .form{ padding:20px; display:grid; grid-template-columns:repeat(12,1fr); gap:14px; }
        
        .field{ grid-column:span 12; display:flex; flex-direction:column; gap:6px; position:relative; }
        @media (min-width:720px){ .field.half{ grid-column:span 6; } .field.third{ grid-column:span 4; } .field.quarter{ grid-column:span 3; } }
        
        label{ font-size:12px; color:#0e2a47; font-weight:600; letter-spacing:.2px; }
        
        /* Zde pou≈æita tmav≈°√≠ barva --input-border */
        input[type="text"], select { 
            width:100%; 
            border:1px solid var(--input-border); 
            background:#fff; 
            color:#102a43; 
            padding:10px 12px; 
            border-radius:10px; 
            outline:none; 
            transition:border-color .15s ease, box-shadow .15s ease; 
            height: 42px; 
        }
        
        input::placeholder{ color:#829ab1; }
        input:focus, select:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,93,168,.18); }
        
        .divider{ height:1px; background:var(--border); margin:16px 0; grid-column:1 / -1; }
        .section-title { grid-column: 1 / -1; font-size: 16px; font-weight: 700; color: var(--accent); margin-top: 10px; margin-bottom: 5px; }

        /* Drop Zone Styles */
        .drop-zone {
            grid-column: 1 / -1;
            border: 2px dashed var(--accent);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background-color: #f0f7ff;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--accent);
            font-weight: 500;
        }
        .drop-zone:hover, .drop-zone.dragover {
            background-color: #e0efff;
            transform: scale(1.01);
        }
        .drop-zone p { margin: 0; pointer-events: none; }
        .drop-zone-success { border-color: var(--success); color: var(--success); background-color: #e8f5e9; }

        /* Factor row layout */
        .factor-row { display: flex; gap: 10px; }
        .factor-sel { flex: 3; }
        .cat-sel { flex: 1; min-width: 80px; }

        /* Actions */
        .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:24px; }
        button{ border:1px solid var(--accent); background:#fff; color:var(--accent); padding:12px 24px; border-radius:12px; cursor:pointer; transition:.15s ease all; font-weight: 600; font-size: 14px; }
        button.primary{ background:var(--accent); color:#fff; }
        button:hover{ filter:brightness(.95); box-shadow:0 4px 16px rgba(0,93,168,.18); transform: translateY(-1px); }
        
        /* Alerts */
        .alert-box {
            display: none;
            background: #ffebee;
            border: 1px solid var(--error);
            color: #c62828;
            padding: 12px;
            border-radius: 10px;
            margin-top: 10px;
            text-align: center;
            font-size: 13px;
        }
        .alert-box button {
            background: var(--error);
            color: white;
            border: none;
            padding: 6px 12px;
            margin-top: 8px;
            font-size: 12px;
        }
        
        #libError {
            position: fixed; top: 0; left: 0; right: 0;
            background: var(--error); color: white; padding: 10px;
            text-align: center; z-index: 1000; font-weight: bold;
            display: none;
        }

        #fileInput, #templateInput { display: none; }
    </style>
</head>
<body>

<!-- Critical Error Banner -->
<div id="libError">
    ‚ö†Ô∏è KRITICK√Å CHYBA: Knihovny se nenaƒçetly. Zkontrolujte p≈ôipojen√≠ k internetu.
</div>

<div class="container">
    <header>
        <h1>L√©ka≈ôsk√Ω posudek</h1>
    </header>

    <section class="card form">
        <!-- Upload Section -->
        <div class="drop-zone" id="dropZone">
            <p>üìÑ Kliknƒõte sem nebo p≈ôet√°hnƒõte PDF dotazn√≠k</p>
            <input type="file" id="fileInput" accept=".pdf">
        </div>

        <!-- Personal Info -->
        <div class="section-title">Osobn√≠ √∫daje z PDF</div>
        
        <div class="field half">
            <label for="jmeno">Jm√©no a p≈ô√≠jmen√≠</label>
            <input type="text" id="jmeno" placeholder="Naƒçte se z PDF...">
        </div>
        <div class="field half">
            <label for="narozeni">Datum narozen√≠</label>
            <input type="text" id="narozeni" placeholder="Naƒçte se z PDF...">
        </div>
        <div class="field code"> <!-- Uses CSS grid span logic -->
            <label for="adresa">Adresa trval√©ho pobytu</label>
            <input type="text" id="adresa" placeholder="Ulice, Mƒõsto">
        </div>
        <div class="field quarter">
            <label for="psc">PSƒå</label>
            <input type="text" id="psc" placeholder="PSƒå">
        </div>

        <div class="divider"></div>

        <!-- Factors -->
        <div class="section-title">Faktory a Kategorie</div>
        
        <!-- Left Column Factors -->
        <div class="field half">
            <div class="factor-container-left">
                <!-- Generated via JS -->
            </div>
        </div>
        <!-- Right Column Factors -->
        <div class="field half">
            <div class="factor-container-right">
                <!-- Generated via JS -->
            </div>
        </div>

        <div class="divider"></div>

        <!-- Job Details -->
        <div class="section-title">Detaily pozice</div>

        <div class="field third">
            <label for="pobocka">Poboƒçka</label>
            <select id="pobocka"></select>
        </div>
        <div class="field third">
            <label for="pozice">Pozice (n√°zev)</label>
            <input type="text" id="pozice">
        </div>
        <div class="field third">
            <label for="konzultant">Konzultant</label>
            <select id="konzultant"></select>
        </div>

        <div class="field">
            <label for="pozice_popis">Pozice popis (≈°ablona)</label>
            <select id="pozice_popis"></select>
        </div>

        <!-- Manual Template Fallback -->
        <div class="field alert-box" id="manualTemplateSection">
            <div>‚ö†Ô∏è Prohl√≠≈æeƒç zablokoval automatick√© naƒçten√≠ ≈°ablony (CORS/Lok√°ln√≠ disk).</div>
            <button onclick="document.getElementById('templateInput').click()">Vybrat soubor LP_template.docx ruƒçnƒõ</button>
            <div id="templateNameDisplay" style="margin-top:5px; font-style:italic; color:#333;"></div>
            <input type="file" id="templateInput" accept=".docx">
        </div>

    </section>

    <div class="actions">
        <button class="primary" onclick="generateDocx()">Generovat DOCX</button>
    </div>
</div>

<script>
    // --- DATA ---
    const FACTOR_OPTIONS = ["", "Z√°tƒõ≈æ chladem", "Fyzick√° z√°tƒõ≈æ", "Pracovn√≠ poloha", "Hluk", "Vibrace", "Prach", "Chemick√© l√°tky a smƒõsi", "------------------", "Biologick√© ƒçinitele", "ƒåinnosti epidemiologicky z√°va≈æn√©", "Elektrotechnik dle vyhl ƒç.50 / 1978 Sb.", "Neionizuj√≠c√≠ z√°≈ôen√≠", "Obsluha tlakov√Ωch n√°dob a za≈ô√≠zen√≠ vys. napƒõt√≠", "Obsluha transport. a vysokozdvi≈æn√Ωch voz√≠k≈Ø", "Obsluha transport. vyt√°h≈Ø a je≈ô√°b≈Ø a v√°zan√≠ b≈ôemen", "Pr√°ce v noci", "Pr√°ce ve v√Ω≈°k√°ch a nad volnou hloubkou", "Psychick√° z√°tƒõ≈æ", "≈òidiƒç v pracovnƒõpr√°vn√≠m vztahu do 7,5 tuny", "≈òidiƒç v pracovnƒõpr√°vn√≠m vztahu nad 7,5 tuny", "Vy≈°et≈ôen√≠ v z√°kladn√≠m rozsahu", "Z√°te≈æ teplem", "Zrakov√° z√°tƒõ≈æ"];
    const CATEGORIES = ["", "Kat. 1", "Kat. 2", "Kat. 3", "Kat. 4"];
    
    const position_descriptions = {
        "Call Centrum": "ƒåinnost spojen√° s jedn√°n√≠m s klienty/zamƒõstnanci po telefonu, prac√≠ na poƒç√≠taƒçi a administrativn√≠mi √∫kony. Provoz: dvousmƒõnn√Ω, Pracovn√≠ doba: 8 hodinov√© smƒõny (pondƒõl√≠ - nedƒõle) v pr≈Ømƒõru 40 hodin/t√Ωdnƒõ.",
        "Mana≈æer/Z√°stupce mana≈æera": "Administrativn√≠ ƒçinnost spojen√° s prac√≠ na poƒç√≠taƒçi, s veden√≠m pracovn√≠ho t√Ωmu a jedn√°n√≠ s klienty. Souƒç√°st√≠ pr√°ce je ≈ô√≠zen√≠ slu≈æebn√≠ho vozidla. Provoz: jednosmƒõnn√Ω, Pracovn√≠ doba: 12 hodinov√© smƒõny (kr√°tk√Ω/dlouh√Ω t√Ωden)",
        "Prodejce": "ƒåinnost spojen√° s prac√≠ na poƒç√≠taƒçi a jedn√°n√≠ s klienty. Souƒç√°st√≠ pr√°ce je ≈ô√≠zen√≠ vozidla. Pr√°ce je vykon√°van√° v administrativn√≠ch budov√°ch a z√°rove≈à ve venkovn√≠ch prostorech. V zimn√≠ch mƒõs√≠c√≠ch nen√≠ p≈ôekroƒçena hranice ƒçty≈ô hodin za pracovn√≠ dobu, kdyby zamƒõstnanci byli vystaveni operativn√≠ teplotƒõ +4 st. C a ni≈æ≈°√≠. Pr√°ce prodejce je spojen√° se st≈ô√≠d√°n√≠m pobytu v teple a v chladu. Provoz: jednosmƒõnn√Ω, Pracovn√≠ doba: 12 hodinov√© smƒõny (kr√°tk√Ω/dlouh√Ω t√Ωden)",
        "N√°kupƒç√≠ / Testovac√≠ technik": "Administrativn√≠ ƒçinnost spojen√° s prac√≠ na poƒç√≠taƒçi a jedn√°n√≠ s klienty. Souƒç√°st√≠ pr√°ce je ≈ô√≠zen√≠ vozidla. Obƒçasn√Ω pohyb ve venkovn√≠ch prostorech. Provoz: jednosmƒõnn√Ω, Pracovn√≠ doba: 12 hodinov√© smƒõny (kr√°tk√Ω/dlouh√Ω t√Ωden)",
        "Mobiln√≠ n√°kupƒç√≠": "Administrativn√≠ ƒçinnost spojen√° s prac√≠ na poƒç√≠taƒçi a jedn√°n√≠ s klienty. Souƒç√°st√≠ pr√°ce je ≈ô√≠zen√≠ vozidla (v√≠ce ne≈æ 60%). Obƒçasn√Ω pohyb ve venkovn√≠ch prostorech. Provoz: jednosmƒõnn√Ω, Pracovn√≠ doba: 12 hodinov√© smƒõny (kr√°tk√Ω/dlouh√Ω t√Ωden)",
        "Specialista z√°kaznick√©ho servisu": "Administrativn√≠ ƒçinnost spojen√° s prac√≠ na poƒç√≠taƒçi a jedn√°n√≠ s klienty.  Provoz: jednosmƒõnn√Ω, Pracovn√≠ doba: 12 hodinov√© smƒõny (kr√°tk√Ω/dlouh√Ω t√Ωden)",
        "Mobiln√≠ Specialista z√°kaznick√©ho servisu": "Administrativn√≠ ƒçinnost spojen√° s prac√≠ na poƒç√≠taƒçi a jedn√°n√≠ s klienty. Souƒç√°st√≠ pr√°ce je ≈ô√≠zen√≠ vozidla.  Provoz: jednosmƒõnn√Ω, Pracovn√≠ doba: 12 hodinov√© smƒõny (kr√°tk√Ω/dlouh√Ω t√Ωden)",
        "Administrativa": "Administrativn√≠ ƒçinnost spojen√° s prac√≠ na poƒç√≠taƒçi, zakl√°d√°n√≠m slo≈æek a jedn√°n√≠ se zamƒõstnanci/klienty. Provoz: jednosmƒõnn√Ω, Pracovn√≠ doba: 8 hodinov√© smƒõny (pondƒõl√≠ - p√°tek)",
        "Operaƒçn√≠ t√Ωm/Pracovn√≠k podpory prodeje/Vedouc√≠ √∫seku/Mobiln√≠ pracovn√≠k podpory prodeje": "Drobn√© pr√°ce v d√≠lnƒõ, myt√≠ a ƒçi≈°tƒõn√≠ automobil≈Ø, ƒç√°st pracovn√≠ doby je pr√°ce venku. Souƒç√°st√≠ pr√°ce je ≈ô√≠zen√≠ vozidla. Pr√°ce s chemick√Ωmi l√°tkami s H314. H340, H350, H372. Provoz: jednosmƒõnn√Ω, Pracovn√≠ doba: 12 hodinov√© smƒõny (kr√°tk√Ω/dlouh√Ω t√Ωden)",
        "Ukl√≠zeƒçka": "Prov√°d√≠ √∫klidov√© pr√°ce, myt√≠, ƒçi≈°tƒõn√≠, vyn√°≈°en√≠ odpadk≈Ø. Provoz: jednosmƒõnn√Ω, Pracovn√≠ doba: 8 hodinov√© smƒõny (pondƒõl√≠ - p√°tek)",
        "Stock kontrolor": "P≈ôevoz automobil≈Ø v objektu spoleƒçnosti, kontrola vozov√©ho parku, obƒçasn√° pr√°ce s poƒç√≠taƒçem. Souƒç√°st√≠ pr√°ce je ≈ô√≠zen√≠ vozidla. Provoz: jednosmƒõnn√Ω, Pracovn√≠ doba: 8 hodinov√© smƒõny (pondƒõl√≠ - p√°tek)",
        "≈òidiƒç do 7,5t/ Kur√Ωr": "Prov√°d√≠ p≈ôepravu z√°kazn√≠k≈Ø a vozidel. Souƒç√°st√≠ pr√°ce je ≈ô√≠zen√≠ vozidla. Provoz: jednosmƒõnn√Ω, Pracovn√≠ doba: 8 hodinov√© smƒõny (pondƒõl√≠ - p√°tek)",
        "≈òidiƒç nad 7,5t": "Prov√°d√≠ p≈ôepravu voz≈Ø mezi poboƒçkami, nakl√°dka a vykl√°dka voz≈Ø. Souƒç√°st√≠ pr√°ce je ≈ô√≠zen√≠ vozidla nad 7,5 tuny. Provoz: jednosmƒõnn√Ω, Pracovn√≠ doba: 8 hodinov√© smƒõny (pondƒõl√≠ - p√°tek)",
        "Technik se zamƒõ≈ôen√≠m na opravy detail≈Ø": "Prov√°d√≠ drobn√© opravy detail≈Ø vozu. Souƒç√°st√≠ pr√°ce je ≈ô√≠zen√≠ vozidla. Provoz: jednosmƒõnn√Ω, Pracovn√≠ doba: 8 hodinov√© smƒõny (pondƒõl√≠ - p√°tek)",
        "Mechanik": "Prov√°d√≠ √∫dr≈æbu, opravy a se≈ôizov√°n√≠ silniƒçn√≠ch motorov√Ωch vozidel. Pr√°ce s chemick√Ωmi l√°tkami s H314. Souƒç√°st√≠ pr√°ce je ≈ô√≠zen√≠ vozidla. Provoz: jednosmƒõnn√Ω, Pracovn√≠ doba: 8 hodinov√© smƒõny (pondƒõl√≠ - p√°tek)",
        "V√Ωpomoc p≈ôi p≈ôepravƒõ voz≈Ø mezi poboƒçkami": "Prov√°d√≠ p≈ôepravu z√°kazn√≠k≈Ø a vozidel. Souƒç√°st√≠ pr√°ce je ≈ô√≠zen√≠ vozidla. Provoz: jednosmƒõnn√Ω, DPP spolupr√°ce.",
        "V√Ωpomoc p≈ôi prodeji voz≈Ø": "ƒåinnost spojen√° s prac√≠ na poƒç√≠taƒçi a jedn√°n√≠ s klienty. Souƒç√°st√≠ pr√°ce je ≈ô√≠zen√≠ vozidla. Pr√°ce je vykon√°van√° v administrativn√≠ch budov√°ch a z√°rove≈à ve venkovn√≠ch prostorech. V zimn√≠ch mƒõs√≠c√≠ch nen√≠ p≈ôekroƒçena hranice ƒçty≈ô hodin za pracovn√≠ dobu, kdyby zamƒõstnanci byli vystaveni operativn√≠ teplotƒõ +4 st. C a ni≈æ≈°√≠. Pr√°ce je spojen√° se st≈ô√≠d√°n√≠m pobytu v teple a v chladu. Povaha pr√°ce n√°razov√° (dohoda o proveden√≠ pr√°ce), smƒõny maxim√°lnƒõ 8hodinov√©."
    };
    const branch_list = ["Brno", "Chomutov", "ƒåesk√© Budƒõjovice", "ƒåestlice", "Hradec Kr√°lov√©", "Jihlava", "Kladno", "Kol√≠n", "Liberec", "Mlad√° Boleslav", "Olomouc", "Opava", "Ostrava", "Pardubice", "Plze≈à", "Praha", "Sokolov", "T√°bor", "Teplice", "√öst√≠ nad Labem", "Vala≈°sk√© Mezi≈ô√≠ƒç√≠", "Zl√≠n", "Znojmo"];
    
    // Aktualizovan√Ω seznam konzultant≈Ø
    const consultant_list = [
        "Andrea Je≈ô√°bkov√°", 
        "Anna Kuƒçerov√°", 
        "Blanka Poliakov√°", 
        "Jan Jarma", 
        "Kamila Hu≈°kov√°", 
        "Karol√≠na Kulvaitov√°", 
        "Kl√°ra Stloukalov√°",
        "Miroslava V√°lkov√°", 
        "Ond≈ôej Dolej≈°"
    ];

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        // Library Check
        if (typeof PizZip === 'undefined' || typeof window.docxtemplater === 'undefined') {
            document.getElementById('libError').style.display = 'block';
        }

        // Fill Selects
        fillSelect('pobocka', branch_list);
        fillSelect('konzultant', consultant_list);
        fillSelect('pozice_popis', Object.keys(position_descriptions));

        // Generate Factors HTML
        const leftContainer = document.querySelector('.factor-container-left');
        const rightContainer = document.querySelector('.factor-container-right');
        
        for(let i=0; i<6; i++) {
            const row = document.createElement('div');
            row.className = 'factor-row';
            row.style.marginBottom = '10px';
            
            // Factor Select
            const selF = document.createElement('select');
            selF.className = 'factor-sel';
            fillSelectObj(selF, FACTOR_OPTIONS);
            
            // Category Select
            const selC = document.createElement('select');
            selC.className = 'cat-sel';
            fillSelectObj(selC, CATEGORIES);

            row.appendChild(selF);
            row.appendChild(selC);

            if(i < 3) leftContainer.appendChild(row);
            else rightContainer.appendChild(row);
        }

        // Set defaults
        const allFactors = document.querySelectorAll('.factor-sel');
        const allCats = document.querySelectorAll('.cat-sel');
        if(allFactors.length > 0) allFactors[0].value = "Vy≈°et≈ôen√≠ v z√°kladn√≠m rozsahu";
        if(allCats.length > 0) allCats[0].value = "Kat. 1";
    });

    function fillSelect(id, array) {
        const sel = document.getElementById(id);
        array.sort((a, b) => a.localeCompare(b, 'cs')).forEach(item => {
            const opt = document.createElement('option'); opt.value = item; opt.textContent = item; sel.appendChild(opt);
        });
    }
    function fillSelectObj(selectObj, array) {
        array.forEach(item => {
            const opt = document.createElement('option'); opt.value = item; opt.textContent = item; selectObj.appendChild(opt);
        });
    }

    // --- PDF LOGIC ---
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const templateInput = document.getElementById('templateInput');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault(); dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) processPDF(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', (e) => { if (e.target.files.length) processPDF(e.target.files[0]); });
    
    // Manual template indicator
    templateInput.addEventListener('change', (e) => {
        if(e.target.files.length) {
            document.getElementById('templateNameDisplay').textContent = "Vybr√°no: " + e.target.files[0].name;
            document.getElementById('manualTemplateSection').style.borderColor = "#388E3C";
            document.getElementById('manualTemplateSection').style.background = "#e8f5e9";
            document.getElementById('manualTemplateSection').style.color = "#2e7d32";
        }
    });

    async function processPDF(file) {
        if (file.type !== 'application/pdf') { alert("Vyberte pros√≠m PDF soubor."); return; }
        if (typeof PDFLib === 'undefined') { alert("Chyba: Knihovna PDF-LIB se nenaƒçetla."); return; }

        const arrayBuffer = await file.arrayBuffer();
        const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
        const form = pdfDoc.getForm();
        
        try {
            const getField = (name) => { try { return form.getTextField(name).getText() || ""; } catch(e) { return ""; } };
            const jmeno = getField('jmeno');
            let narozeni = getField('narozeni');
            if(narozeni.includes('/')) narozeni = narozeni.split('/')[0].trim();
            const adresaUlice = getField('trvale-bydliste-ulice');
            const mesto = getField('trvale-bydliste-mesto');
            const psc = getField('trvale-bydliste-psc');

            document.getElementById('jmeno').value = jmeno;
            document.getElementById('narozeni').value = narozeni;
            document.getElementById('adresa').value = (adresaUlice + ", " + mesto).replace(/^, |, $/g, '');
            document.getElementById('psc').value = psc;
            
            dropZone.innerHTML = `<p style="font-weight:bold">‚úÖ PDF naƒçteno: ${file.name}</p>`;
            dropZone.classList.add('drop-zone-success');
        } catch (err) { console.error(err); alert("Chyba p≈ôi ƒçten√≠ PDF."); }
    }

    // --- GENERATOR ---
    async function generateDocx() {
        if (typeof PizZip === 'undefined') {
            alert("FAT√ÅLN√ç CHYBA: Knihovna PizZip nen√≠ naƒçtena.");
            return;
        }

        let templateBuffer;
        try {
            if (templateInput.files.length > 0) {
                 templateBuffer = await templateInput.files[0].arrayBuffer();
            } else {
                const response = await fetch('LP_template.docx');
                if (!response.ok) throw new Error("Fetch failed");
                templateBuffer = await response.arrayBuffer();
            }
        } catch (e) {
            document.getElementById('manualTemplateSection').style.display = 'block';
            alert("Prohl√≠≈æeƒç zablokoval automatick√© naƒçten√≠ ≈°ablony. Pou≈æijte tlaƒç√≠tko pro ruƒçn√≠ v√Ωbƒõr v doln√≠ ƒç√°sti formul√°≈ôe.");
            return;
        }

        // Data Collection
        const factorSelects = document.querySelectorAll('.factor-sel');
        const catSelects = document.querySelectorAll('.cat-sel');
        const factorsData = {};
        factorSelects.forEach((sel, i) => {
            factorsData[`faktor${i+1}`] = sel.value;
            factorsData[`kategorie${i+1}`] = catSelects[i].value;
        });

        const selectedPopis = document.getElementById('pozice_popis').value;
        const data = {
            jmeno: document.getElementById('jmeno').value,
            narozeni: document.getElementById('narozeni').value,
            adresa: document.getElementById('adresa').value,
            psc: document.getElementById('psc').value,
            pozice: document.getElementById('pozice').value,
            pobocka: document.getElementById('pobocka').value,
            konzultant: document.getElementById('konzultant').value,
            datum: new Date().toLocaleDateString('cs-CZ'),
            pozice_popis: selectedPopis,
            popis_pozice: position_descriptions[selectedPopis] || "",
            ...factorsData
        };

        // Generation
        try {
            const zip = new PizZip(templateBuffer);
            const doc = new window.docxtemplater(zip, { 
                paragraphLoop: true, 
                linebreaks: true,
                nullGetter: function() { return ""; } 
            });
            
            doc.render(data);
            
            const out = doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
            const surname = data.jmeno.split(" ").pop() || "nezadano";
            saveAs(out, `LP_${surname}.docx`);
        } catch (error) {
            alert("Chyba p≈ôi generov√°n√≠ DOCX: " + error.message);
            console.error(error);
        }
    }
</script>
</body>
</html>